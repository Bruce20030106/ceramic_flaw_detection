
### 什么是缺陷检测
缺陷是指在机器视觉任务中，与人类经验不符合的图像区域。缺陷检测可以划分为三个层次：缺陷是什么（分类）、缺陷在哪里（定位）和缺陷是多少（分割）
- 缺陷分类是指给出图像或区域的类别信息，例如异色、空洞、经线等。
- 缺陷定位是指给出缺陷的具体位置，例如矩形框或热力图。
- 缺陷分割是指将缺陷逐像素从背景中分割出来，并能得到缺陷的长度、面积、位置等信息。

##  表面缺陷检测深度学习方法
![](https://github.com/OctoberEnd/verbose-invention/blob/main/%E7%BC%BA%E9%99%B7%E6%A3%80%E6%B5%8B%E6%96%B9%E6%B3%95.jpg?raw=true)
### 表征学习
现阶段大部分基于深度学习的表面缺陷检测是基于有监督的表征学习方法. 表征学习的本质是将缺陷检测问题看作计算机视觉中的分类任务, 包括粗粒度的图像标签分类或区域分类。
### 分类网络
分类网络是指将缺陷检测问题看作计算机视觉中的分类任务，包括图像标签分类、区域分类和像素分类。   
- 分类网络的特征提取部分由级联的卷积层和池化层组成，后面连接全连接层或平均池化层和 softmax 结构用于分类。
- 分类网络可以采用计算机视觉中现成的网络结构，例如 AlexNet、VGG、GoogLeNet、ResNet 等，或者针对实际问题搭建简易的网络结构。
分类网络可以细分为三个小类：直接利用网络进行分类、利用网络进行缺陷定位和利用网络作为特征提取器。
![](https://github.com/OctoberEnd/verbose-invention/blob/main/%E4%BC%98%E7%BC%BA%E7%82%B9.jpg?raw=true)
#### 1.直接利用网络进行分类
直接利用网络进行分类是指将收集的完整缺陷图像或感兴趣的区域放入网络进行学习训练，网络输出该图像或区域的类别和置信度。
- 直接利用网络进行分类可以进一步细分为原图分类、定位感兴趣区域后分类和多类别分类三种。
1. 原图分类是指直接将整幅缺陷图像放入网络进行训练，适用于缺陷成像与背景差异大、对比度高、缺陷尺度变化小且类型单一的情况。
2. 定位感兴趣区域后分类是指先通过一些方法获取到感兴趣的区域，然后将该区域输入网络进行缺陷类别的判断，适用于缺陷位置固定或可预测的情况。
3. 多类别分类是指当待分类的缺陷类型超过两类时，常常先采用一个基础网络进行缺陷与正常样本二分类，然后在同一个网络上共享特征提取部分，修改或增加缺陷类别的分类分支，适用于缺陷样本与正常样本数目不均衡的情况。
#### 2.利用网络进行缺陷定位
利用网络进行缺陷定位是指结合不同的技巧和方式，使分类网络也可以实现缺陷的粗定位或逐像素的分类。
- 利用网络进行缺陷定位可以细分为滑动窗口、热力图和多任务学习网络三种形式。
1. 滑动窗口是最简单和直观的实现缺陷粗定位的方法，通过较小尺寸的窗口在原始图像上进行冗余滑动，将滑动窗口中的图像输入到分类网络中进行缺陷识别，然后将所有的滑动窗口进行连接，即可获得缺陷粗定位的结果。
2. 热力图是一种反映图像中各区域重要性程度的图像，颜色越深代表越重要，在缺陷检测领域，热力图中颜色越深的区域代表其属于缺陷的概率越大，可以通过不同的方法获取热力图，例如图像分块和特征迁移、CAM 和 Grad-CAM 等。
3. 多任务学习网络是指设计的网络会加上额外的分割分支，两个分支共享特征提取的骨架，这样网络一般有分类和分割两个输出，构成多任务学习网络，它兼顾两个网络特点，对于分割网络分支，图像中每个像素都能被当作训练样本来训练网络，不仅利用分割分支输出缺陷具体的分割结果，而且可以大大减少分类网络对样本的需求。
#### 3.利用网络做特征提取器
利用 CNN 特征提取的强大功能, 先将图像输入到预训练网络中获取图像表征特征, 再将获取的特征输入到常规的机器学习分类器 (例如 SVM等) 中进行分类.
   
### 检测网络
检测网络是指将缺陷检测问题看作计算机视觉中的定位任务，其目的是获得缺陷精准的位置和类别信息。   
检测网络可以划分为两种类型：基于两阶段的检测网络和基于一阶段的检测网络，两者的主要差异在于两阶段网络需要首先生成可能包含缺陷的候选框，然后再进一步进行目标检测，一阶段网络则直接利用网络中提取的特征来预测缺陷的位置和类别。   
#### 1.两阶段的检测网络
- 基于两阶段的检测网络以 Faster R-CNN 为代表，其基本流程是首先通过 Backbone 网络获取输入图像的特征图，利用区域生成网络 RPN 计算锚框置信度，获取 Proposal 区域，然后对 Proposal 区域的特征图进行 ROIpooling 后输入网络，通过对初步检测结果进行精细调整，得到最终的缺陷位置和类别。
- **KEY——改进方法：对 Backbone 结构或其特征图、锚框比例、ROIpooling 和损失函数等方面进行改进**.具体例子可看论文绿色标注
#### 2.一阶段的检测网络
- 基于一阶段的检测网络以 SSD 或 YOLO 为代表，其基本流程是直接在 Backbone 网络提取的特征图上预测不同尺度和长宽比的锚框，并对每个锚框进行分类和回归，得到最终的缺陷位置和类别。
- **KEY——改进方法：可以根据不同的 Backbone 网络、RPN 网络、ROIpooling 方法和损失函数进行改进和优化，例如使用 ResNet、FPN、RoIAlign 和 Focal Loss 等。**

### 分割网络
- 分割网络是指将缺陷检测问题看作计算机视觉中的分割任务，其目的是将缺陷逐像素从背景中分割出来，并能进一步得到缺陷的长度、面积、位置等等一系列信息。
- 分割网络可以划分为两种类型：基于 FCN 网络和基于 Mask R-CNN 网络
1. 基于 FCN 网络的分割网络以 U-Net 为代表，其基本流程是首先通过一个编码器网络对输入图像进行特征提取和下采样，然后通过一个解码器网络对特征图进行上采样和特征融合，最后通过一个分类器网络对每个像素进行分类，得到最终的缺陷分割结果。   
- 补充：生成对抗网络   
生成器往往直接采用 FCN 网络, 判别器通过分类模型来区分生成器的结果和 Groundtruth，通过生成器和判别器的不断博弈, 让生成器的输出结果逐渐接近 Groundtruth   
2. 基于 Mask R-CNN 网络的分割网络以 Mask R-CNN 为代表，其基本流程是首先通过 Backbone 网络获取输入图像的特征图，利用区域生成网络 RPN 计算锚框置信度，获取 Proposal 区域，然后对 Proposal 区域的特征图进行 ROIAlign 后输入网络，通过对初步检测结果进行精细调整，得到最终的缺陷位置和类别，并且在检测分支的基础上增加一个分割分支，用于预测每个 Proposal 区域内缺陷的掩码。

***

## 三种任务设置划分
《工业缺陷检测深度学习方法综述》
### 缺陷模式已知
一般采用有监督深度学习方法，需要充足而精确的样本标注，可以从分类、检测与分割三种角度进行方法设计。
### 缺陷模式未知
一般采用无监督深度学习方法构造比较对象，根据比较对象维度的不同，可分为在图像维度与在特征维度比较相似度，并基于方法的原理进一步细分。
- 基于图像相似度的方法是一种无监督深度学习方法，其思路是利用正常样本构建参考图像，然后与待测图像进行比较，根据相似度的差异来判断是否存在缺陷。
1. 图像重建
重建型方法通过编码器-解码器结构将输入图像映射到一个低维空间，然后重建出输出图像，比较输入和输出图像的差异。   
基础框架（如图）：AE自编码器、VAE变分自编码器、GAN生成对抗模型、AE和GAN结合
![](https://github.com/OctoberEnd/verbose-invention/blob/main/%E5%9B%BE%E5%83%8F%E7%9B%B8%E4%BC%BC%E5%BA%A6.jpg?raw=true)

自编码器 (autoencoder, AE) 是一种经典的重建型方法，其由编码器和解码器两部分组成，编码器将输入图像压缩为一个低维向量，解码器将该向量还原为输出图像。   
   
变分自编码器 (variational autoencoder, VAE) 是一种基于概率模型的重建型方法，其在 AE 的基础上引入了随机变量和重参数化技巧，使得编码器输出的不是一个确定的向量，而是一个概率分布的参数。   
    
GAN 由生成器 (generator, G) 和判别器 (discriminator, D) 组成，生成器将从隐空间采样的变量映射为与监督样本尽可能相似的图像, 判别器则对生成样本的真实性进行判断, 旨在能够判别生成的假图, 两者互相对抗进行优化, 使得生成的图像趋于真实与清晰。   
   
2. 图像恢复
基于图像恢复的方法是一种无监督深度学习方法，其思路是将缺陷视为图像中的噪声或模糊，通过学习正常图像的去噪或去模糊映射来实现缺陷检测。
基于图像恢复的方法可以分为去噪自编码器和去模糊网络两种。**去噪自编码器**通过在输入图像中加入人为噪声，然后训练模型去除噪声，从而学习到正常图像的特征。**去模糊网络**则通过在输入图像中加入人为模糊（称为掩膜），然后训练模型去除模糊，从而学习到正常图像的特征。

- 基于特征相似度的方法
借助深度神经网络的特征提取能力, 此类方法的核心目的是找到具有区分性的特征嵌入。
1. 深度一类分类 (deep one-class classification, DOCC) 
其思路是利用正常样本训练一个深度神经网络，使得正常样本在特征空间中聚集在一个紧凑的超球体内，然后根据待测样本与超球体中心的距离来判断是否存在缺陷。
2. 特征距离测量(feature distance measuring, FDM) 选择直接使用预训练模型来描述图像的特征。
其思路是利用正常样本训练一个深度神经网络，使得正常样本在特征空间中具有较高的相似度，然后根据待测样本与正常样本之间的特征距离来判断是否存在缺陷。
![](https://github.com/OctoberEnd/verbose-invention/blob/main/%E5%9F%BA%E4%BA%8E%E7%89%B9%E5%BE%81%E7%9B%B8%E4%BC%BC%E5%BA%A6.jpg?raw=true)
- 孪生网络架构 (siamese network architecture) 是一种基于特征距离测量的框架，其由两个共享参数的编码器组成，分别对输入图像和参考图像进行特征提取，然后计算两个特征向量之间的距离或相似度，作为缺陷检测的依据。
- 教师 – 学生架构 (teacher-student architecture) 是一种基于特征距离测量的框架，其由一个教师网络和一个学生网络组成，教师网络用正常样本训练一个深度神经网络，学生网络则用待测样本作为输入，然后计算教师网络和学生网络输出的特征向量之间的距离或相似度，作为缺陷检测的依据。
- 深度一类分类模型 (deep one-class classification model) 是一种基于深度单类分类的框架，其由一个编码器和一个映射层组成，编码器用正常样本训练一个深度神经网络，映射层将编码器输出的特征向量映射到一个紧凑的超球体内，然后根据待测样本与超球体中心的距离来判断是否存在缺陷。
- 深度统计模型 (deep statistical model) 是一种基于深度单类分类的框架，其由一个编码器和一个统计层组成，编码器用正常样本训练一个深度神经网络，统计层将编码器输出的特征向量拟合为一个概率分布，然后根据待测样本与概率分布之间的偏离程度来判断是否存在缺陷。
### 少量缺陷标志
少量缺陷标注的场景贴近实际工业情况，训练集中包含比例不均衡正负样本，且只有少量的缺陷样本具有精确或不精确的标注。此时，根据具体的数据标注情况，分别采用小样本、半监督和弱监督等新兴方法来处理。
#### 小样本学习
解决问题：实际工业生产中可提供的样本总数较小, 对于次品率的把控严苛, 又直接导致缺陷样本的获取非常困难, 从而难以构建理想的数据集.
- 网络优化：
1. 对于过拟合问题, 可以选择更加合理的网络结构、度量方式和损失函数来抑制
2. （难）合理的网络设计与稳定的优化过程有助于网络快速收敛, 使模型在小型数据集上也能有良好的性能
- 数据扩增
1. 充分利用所给数据, 基于对缺陷的特点, 有针对性地设计相应的缺陷数据与正常样本叠加进行缺陷样本的扩充。如：仿射变换、高斯模糊以及添加椒盐噪声；生成随机掩模与正常样本叠加模拟真实缺陷模式；从缺陷样本中裁剪出缺陷部位与随机正常样本进行组合叠加。
2. 问题：针对某一具体场景设计的缺陷形式难以泛化到其他场景, 不能从根本上解决小样本问题
- 知识迁移
问题：正负样本失衡的训练集对模型从零开始训练极易导致模型失效
1. 迁移学习是一种机器学习的方法，指的是将一个预训练的模型应用到另一个不同但相关的任务上，利用已有的知识和经验来提高学习效率和性能
2. 元学习 (meta-learning) 的技术，即在一个大规模的元数据集上训练一个元模型，使其能够快速适应新的缺陷类型和新的数据分布

**对半监督学习、自监督学习，弱监督学习不作介绍**










